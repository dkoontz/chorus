module SpecTests exposing (tests)

{-| Unit tests for Agent.Spec module.
-}

import Agent.Spec as Spec
import Task


tests : Array { name : String, run : Task.Task String {} }
tests =
    [ testExtractsNameFromTitle
    , testExtractsSystemPromptBeforeFirstSection
    , testHandlesNoSections
    , testFailsOnMissingTitle
    , testFailsOnEmptySystemPrompt
    , testHandlesWhitespaceOnlyContent
    , testPreservesMultilineFormatting
    , testHandlesTitleWithExtraSpaces
    , testParsesDeveloperAgentFormat
    ]


-- TEST HELPERS


expectEqual : a -> a -> Task.Task String {}
expectEqual expected actual =
    if expected == actual then
        Task.succeed {}
    else
        Task.fail
            ("Expected: "
                ++ Debug.toString expected
                ++ "\nActual: "
                ++ Debug.toString actual
            )


expectPass : Task.Task String {}
expectPass =
    Task.succeed {}


expectFail : String -> Task.Task String {}
expectFail msg =
    Task.fail msg


-- TESTS


testExtractsNameFromTitle : { name : String, run : Task.Task String {} }
testExtractsNameFromTitle =
    { name = "Agent.Spec: extracts name from title"
    , run =
        let
            input =
                """
# Developer Agent

You are a developer agent.

## Parameters
Some parameters here.
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                expectEqual spec.name "Developer Agent"

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }


testExtractsSystemPromptBeforeFirstSection : { name : String, run : Task.Task String {} }
testExtractsSystemPromptBeforeFirstSection =
    { name = "Agent.Spec: extracts system prompt before first section"
    , run =
        let
            input =
                """
# Test Agent

This is the system prompt.
It spans multiple lines.

## First Section
Content after section.
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                expectEqual spec.systemPrompt "This is the system prompt.\nIt spans multiple lines."

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }


testHandlesNoSections : { name : String, run : Task.Task String {} }
testHandlesNoSections =
    { name = "Agent.Spec: handles no sections (uses all content after title)"
    , run =
        let
            input =
                """
# Simple Agent

Just a simple system prompt with no sections.
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                expectEqual spec.systemPrompt "Just a simple system prompt with no sections."

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }


testFailsOnMissingTitle : { name : String, run : Task.Task String {} }
testFailsOnMissingTitle =
    { name = "Agent.Spec: fails on missing title"
    , run =
        let
            input =
                """
No title here, just content.

## Section
More content.
"""
        in
        when Spec.parseFromString input is
            Ok _ ->
                expectFail "Expected MissingTitle error"

            Err err ->
                when err is
                    Spec.MissingTitle _ ->
                        expectPass

                    _ ->
                        expectFail ("Expected MissingTitle, got: " ++ Spec.parseErrorToString err)
    }


testFailsOnEmptySystemPrompt : { name : String, run : Task.Task String {} }
testFailsOnEmptySystemPrompt =
    { name = "Agent.Spec: fails on empty system prompt"
    , run =
        let
            input =
                """
# Agent With No Content

## Parameters
Goes straight to section.
"""
        in
        when Spec.parseFromString input is
            Ok _ ->
                expectFail "Expected EmptySystemPrompt error"

            Err err ->
                when err is
                    Spec.EmptySystemPrompt _ ->
                        expectPass

                    _ ->
                        expectFail ("Expected EmptySystemPrompt, got: " ++ Spec.parseErrorToString err)
    }


testHandlesWhitespaceOnlyContent : { name : String, run : Task.Task String {} }
testHandlesWhitespaceOnlyContent =
    { name = "Agent.Spec: handles content with only whitespace before section"
    , run =
        let
            input =
                """
# Agent With Whitespace




## Parameters
"""
        in
        when Spec.parseFromString input is
            Ok _ ->
                expectFail "Expected EmptySystemPrompt error for whitespace-only content"

            Err err ->
                when err is
                    Spec.EmptySystemPrompt _ ->
                        expectPass

                    _ ->
                        expectFail ("Expected EmptySystemPrompt, got: " ++ Spec.parseErrorToString err)
    }


testPreservesMultilineFormatting : { name : String, run : Task.Task String {} }
testPreservesMultilineFormatting =
    { name = "Agent.Spec: preserves multi-line formatting in system prompt"
    , run =
        let
            input =
                """
# Format Test Agent

Line one.

Line three (after blank).

- Bullet one
- Bullet two

## Section
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                let
                    expected =
                        "Line one.\n\nLine three (after blank).\n\n- Bullet one\n- Bullet two"
                in
                expectEqual spec.systemPrompt expected

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }


testHandlesTitleWithExtraSpaces : { name : String, run : Task.Task String {} }
testHandlesTitleWithExtraSpaces =
    { name = "Agent.Spec: handles title with extra spaces"
    , run =
        let
            input =
                """
#   Spaced Title Agent

Content here.
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                expectEqual spec.name "Spaced Title Agent"

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }


testParsesDeveloperAgentFormat : { name : String, run : Task.Task String {} }
testParsesDeveloperAgentFormat =
    { name = "Agent.Spec: parses real developer agent format"
    , run =
        let
            input =
                """
# Developer Agent

You are a developer agent responsible for implementing technical requirements while ensuring code quality.

## Parameters

The orchestrator will provide these parameters when invoking you:
- `TASK_FILE`: Path to the task specification
- `STATUS_FILE`: Path to the status file

## Your Workflow

1. Read the task specification
2. Implement the changes
3. Write your report
"""
        in
        when Spec.parseFromString input is
            Ok spec ->
                expectEqual spec.name "Developer Agent"
                    |> Task.andThen
                        (\_ ->
                            expectEqual spec.systemPrompt "You are a developer agent responsible for implementing technical requirements while ensuring code quality."
                        )

            Err err ->
                expectFail (Spec.parseErrorToString err)
    }
