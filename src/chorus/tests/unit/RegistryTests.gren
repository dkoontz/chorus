module RegistryTests exposing (tests)

{-| Unit tests for Task.Registry module.
-}

import Json.Decode as Decode
import Json.Encode as Encode
import Task
import Types exposing (Task(..), TaskStatus(..), SourceInfo, Attachment)
import Time


tests : Array { name : String, run : Task.Task String {} }
tests =
    [ testTaskEncodeDecode
    , testStatusPending
    , testStatusActive
    , testStatusFailed
    , testSourceInfoEncodeDecode
    , testAttachmentRoundTrip
    , testMalformedAttachmentMissingField
    , testMalformedAttachmentWrongType
    , testMissingTaskTypeFieldFails
    , testTaskEncodeDecodeWithPlanningFields
    , testDescriptionOnlyRoundTrip
    ]


-- TEST HELPERS


expectEqual : a -> a -> Task.Task String {}
expectEqual expected actual =
    if expected == actual then
        Task.succeed {}
    else
        Task.fail
            ("Expected: "
                ++ Debug.toString expected
                ++ "\nActual: "
                ++ Debug.toString actual
            )


-- TESTS


testTaskEncodeDecode : { name : String, run : Task.Task String {} }
testTaskEncodeDecode =
    { name = "Task encodes and decodes correctly"
    , run =
        let
            task =
                DescriptionOnly
                    { id = "test-id-123"
                    , description = "Test Task"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }
                    , agentWorkspace = "/tmp/workspace"
                    , attachments = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testStatusPending : { name : String, run : Task.Task String {} }
testStatusPending =
    { name = "Pending status encodes and decodes"
    , run =
        testStatusRoundTrip Pending
    }


testStatusActive : { name : String, run : Task.Task String {} }
testStatusActive =
    { name = "Active status encodes and decodes"
    , run =
        testStatusRoundTrip Active
    }


testStatusFailed : { name : String, run : Task.Task String {} }
testStatusFailed =
    { name = "Failed status encodes and decodes with message"
    , run =
        testStatusRoundTrip (Failed "Something went wrong")
    }


testStatusRoundTrip : TaskStatus -> Task.Task String {}
testStatusRoundTrip status =
    let
        task =
            DescriptionOnly
                { id = "test"
                , description = "Test"
                , status = status
                , createdAt = Time.millisToPosix 0
                , updatedAt = Time.millisToPosix 0
                , sessionId = Nothing
                , source =
                    { sourceType = "test"
                    , userId = "test"
                    , conversationId = Nothing
                    }
                , agentWorkspace = "/tmp"
                , attachments = []
                }

        encoded =
            Types.encodeTask task

        json =
            Encode.encode 0 encoded

        decoded =
            Decode.decodeString Types.taskDecoder json
    in
    when decoded is
        Ok decodedTask ->
            expectEqual status (Types.taskStatus decodedTask)

        Err err ->
            Task.fail ("Decode failed: " ++ Decode.errorToString err)


testSourceInfoEncodeDecode : { name : String, run : Task.Task String {} }
testSourceInfoEncodeDecode =
    { name = "SourceInfo with conversationId encodes and decodes"
    , run =
        let
            task =
                DescriptionOnly
                    { id = "test"
                    , description = "Test"
                    , status = Pending
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Just "session-123"
                    , source =
                        { sourceType = "xmpp"
                        , userId = "user@example.com"
                        , conversationId = Just "thread-456"
                        }
                    , agentWorkspace = "/tmp"
                    , attachments = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                if Types.taskSessionId decodedTask == Just "session-123" && (Types.taskSource decodedTask).conversationId == Just "thread-456" then
                    Task.succeed {}
                else
                    Task.fail "sessionId or conversationId mismatch"

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testAttachmentRoundTrip : { name : String, run : Task.Task String {} }
testAttachmentRoundTrip =
    { name = "Task with attachments encodes and decodes correctly"
    , run =
        let
            attachment1 =
                { filename = "readme.md"
                , size = 1024
                , contentType = "text/markdown"
                , uploadedAt = Time.millisToPosix 1707048700000
                }

            attachment2 =
                { filename = "data.csv"
                , size = 2048
                , contentType = "text/csv"
                , uploadedAt = Time.millisToPosix 1707048800000
                }

            task =
                DescriptionOnly
                    { id = "test-attach"
                    , description = "Task with attachments"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }
                    , agentWorkspace = "/tmp/workspace"
                    , attachments = [ attachment1, attachment2 ]
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                let
                    decodedAttachments =
                        Types.taskAttachments decodedTask
                in
                expectEqual 2 (Array.length decodedAttachments)
                    |> Task.andThen
                        (\_ ->
                            when Array.first decodedAttachments is
                                Just a ->
                                    expectEqual "readme.md" a.filename
                                        |> Task.andThen (\_ -> expectEqual 1024 a.size)
                                        |> Task.andThen (\_ -> expectEqual "text/markdown" a.contentType)
                                        |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 1707048700000) a.uploadedAt)

                                Nothing ->
                                    Task.fail "First attachment was Nothing"
                        )
                    |> Task.andThen
                        (\_ ->
                            when Array.get 1 decodedAttachments is
                                Just a ->
                                    expectEqual "data.csv" a.filename
                                        |> Task.andThen (\_ -> expectEqual 2048 a.size)
                                        |> Task.andThen (\_ -> expectEqual "text/csv" a.contentType)
                                        |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 1707048800000) a.uploadedAt)

                                Nothing ->
                                    Task.fail "Second attachment was Nothing"
                        )

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testMalformedAttachmentMissingField : { name : String, run : Task.Task String {} }
testMalformedAttachmentMissingField =
    { name = "Task with malformed attachment fails to decode"
    , run =
        let
            -- Attachment is missing the "contentType" field.
            json =
                "{\"taskType\":\"description_only\",\"id\":\"bad-task\",\"description\":\"Bad\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[{\"filename\":\"f.txt\",\"size\":100,\"uploadedAt\":0}]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testMalformedAttachmentWrongType : { name : String, run : Task.Task String {} }
testMalformedAttachmentWrongType =
    { name = "Task with wrong attachment field type fails to decode"
    , run =
        let
            -- Attachment "size" is a string instead of an int.
            json =
                "{\"taskType\":\"description_only\",\"id\":\"bad-task\",\"description\":\"Bad\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[{\"filename\":\"f.txt\",\"size\":\"not-a-number\",\"contentType\":\"text/plain\",\"uploadedAt\":0}]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testMissingTaskTypeFieldFails : { name : String, run : Task.Task String {} }
testMissingTaskTypeFieldFails =
    { name = "Task JSON without taskType field fails to decode"
    , run =
        let
            json =
                "{\"id\":\"no-type\",\"description\":\"Missing taskType\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testTaskEncodeDecodeWithPlanningFields : { name : String, run : Task.Task String {} }
testTaskEncodeDecodeWithPlanningFields =
    { name = "Task with planning fields encodes and decodes correctly"
    , run =
        let
            task =
                Planned
                    { id = "plan-task-1"
                    , description = "Task with planning data"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }
                    , agentWorkspace = "/tmp/workspace"
                    , attachments = []
                    , summary = "Build a REST API for task management"
                    , requirements = [ "Support CRUD operations", "Use JSON format" ]
                    , acceptanceCriteria = [ "All endpoints return valid JSON", "Error responses include error codes" ]
                    , plan = [ "Define data types", "Implement handlers", "Add tests" ]
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testDescriptionOnlyRoundTrip : { name : String, run : Task.Task String {} }
testDescriptionOnlyRoundTrip =
    { name = "DescriptionOnly task round-trips correctly"
    , run =
        let
            task =
                DescriptionOnly
                    { id = "desc-only"
                    , description = "Simple task"
                    , status = Active
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Just "sess-1"
                    , source =
                        { sourceType = "web"
                        , userId = "user1"
                        , conversationId = Nothing
                        }
                    , agentWorkspace = "/tmp/ws"
                    , attachments = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }
