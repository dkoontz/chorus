module View.Agents exposing
    ( view
    , AgentForm
    , emptyAgentForm
    )

{-| Agent management view for listing, creating, editing, and deleting agents.
-}

import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput, onSubmit)
import Json.Decode
import Set exposing (Set)
import Types exposing (AgentConfig(..), AgentProvider(..), ProviderConfig)


{-| Form state for creating or editing an agent.
-}
type alias AgentForm =
    { name : String
    , instructions : String
    , allowedTools : String
    , provider : String
    , model : String
    , isEditing : Bool  -- True when editing an existing agent
    }


{-| Empty form for creating a new agent.
-}
emptyAgentForm : AgentForm
emptyAgentForm =
    { name = ""
    , instructions = ""
    , allowedTools = "Read,Grep,Glob,Write,Edit,Bash"
    , provider = ""
    , model = ""
    , isEditing = False
    }


type alias Props msg =
    { agents : Array AgentConfig
    , providers : Array ProviderConfig
    , loading : Bool
    , agentForm : Maybe AgentForm
    , onOpenCreateForm : msg
    , onOpenEditForm : AgentConfig -> msg
    , onCloseForm : msg
    , onUpdateName : String -> msg
    , onUpdateInstructions : String -> msg
    , onUpdateAllowedTools : String -> msg
    , onUpdateProvider : String -> msg
    , onUpdateModel : String -> msg
    , onSaveAgent : msg
    , onDeleteAgent : String -> msg
    , onNoOp : msg
    , bulkProviderMode : Bool
    , selectedAgents : Set String
    , bulkProvider : String
    , bulkModel : String
    , onToggleBulkProviderMode : msg
    , onToggleAgentSelected : String -> msg
    , onUpdateBulkProvider : String -> msg
    , onUpdateBulkModel : String -> msg
    , onApplyBulkProvider : msg
    }


view : Props msg -> Html msg
view props =
    div [ class "agents-page" ]
        [ viewAgentsHeader props
        , viewBulkEditBar props
        , viewAgentsTable props
        , viewAgentFormModal props
        ]


viewAgentsHeader : Props msg -> Html msg
viewAgentsHeader props =
    div [ class "agents-header" ]
        [ h2 [] [ text "Agents" ]
        , div [ class "agents-header-actions" ]
            [ button
                [ class "btn btn-secondary"
                , onClick props.onToggleBulkProviderMode
                ]
                [ text
                    (if props.bulkProviderMode then
                        "Cancel Bulk Edit"
                     else
                        "Set Provider"
                    )
                ]
            , button [ class "btn btn-primary", onClick props.onOpenCreateForm ]
                [ text "+ New Agent" ]
            ]
        ]


viewBulkEditBar : Props msg -> Html msg
viewBulkEditBar props =
    if not props.bulkProviderMode then
        text ""
    else
        div [ class "bulk-edit-bar" ]
            [ div [ class "bulk-edit-fields" ]
                [ div [ class "bulk-edit-field" ]
                    [ label [ for "bulk-provider" ] [ text "Provider" ]
                    , select
                        [ id "bulk-provider"
                        , onInput props.onUpdateBulkProvider
                        ]
                        ([ option [ value "", selected (props.bulkProvider == "") ] [ text "-- Select Provider --" ]
                         ]
                            ++ Array.map
                                (\p ->
                                    option
                                        [ value p.name
                                        , selected (props.bulkProvider == p.name)
                                        ]
                                        [ text p.name ]
                                )
                                props.providers
                        )
                    ]
                , div [ class "bulk-edit-field" ]
                    [ label [ for "bulk-model" ] [ text "Model" ]
                    , input
                        [ id "bulk-model"
                        , type_ "text"
                        , value props.bulkModel
                        , onInput props.onUpdateBulkModel
                        , placeholder "e.g. claude-sonnet-4-5-20250929"
                        ]
                        []
                    ]
                , button
                    [ class "btn btn-primary"
                    , onClick props.onApplyBulkProvider
                    , disabled (Set.isEmpty props.selectedAgents)
                    ]
                    [ text "Apply" ]
                ]
            ]


viewAgentsTable : Props msg -> Html msg
viewAgentsTable props =
    if props.loading && Array.isEmpty props.agents then
        div [ class "loading" ] [ text "Loading agents..." ]
    else if Array.isEmpty props.agents then
        div [ class "empty-state" ]
            [ p [] [ text "No agents configured yet." ]
            , p [] [ text "Create an agent to get started." ]
            ]
    else
        table [ class "agents-table" ]
            [ thead []
                [ tr []
                    (( if props.bulkProviderMode then
                        [ th [ class "agents-table-checkbox-col" ] [] ]
                       else
                        []
                     )
                        ++ [ th [] [ text "Name" ]
                           , th [] [ text "Provider" ]
                           , th [] [ text "Status" ]
                           , th [] [ text "Allowed Tools" ]
                           , th [ class "agents-table-actions-col" ] []
                           ]
                    )
                ]
            , tbody []
                (Array.map (viewAgentRow props) props.agents)
            ]


viewAgentRow : Props msg -> AgentConfig -> Html msg
viewAgentRow props agent =
    let
        name =
            Types.agentConfigName agent

        providerNames =
            Array.map .name props.providers

        { providerText, toolsText, isValid } =
            when agent is
                UserDefinedAgent r ->
                    let
                        providerName =
                            when r.provider is
                                NotConfigured ->
                                    "not configured"

                                ProviderRef pName ->
                                    pName

                        valid =
                            when r.provider is
                                NotConfigured ->
                                    False

                                ProviderRef pName ->
                                    Array.any (\p -> p == pName) providerNames
                    in
                    { providerText =
                        providerName
                            ++ (when r.model is
                                    Just m ->
                                        " / " ++ m

                                    Nothing ->
                                        ""
                               )
                    , toolsText = String.join ", " r.allowedTools
                    , isValid = valid
                    }

                InternalAgent _ ->
                    { providerText = "internal"
                    , toolsText = ""
                    , isValid = True
                    }

        statusIcon =
            if isValid then
                span
                    [ class "status-icon status-icon-valid"
                    , title "Provider configured"
                    ]
                    [ text "\u{2713}" ]
            else
                span
                    [ class "status-icon status-icon-invalid"
                    , title "Provider not configured or missing"
                    ]
                    [ text "\u{26A0}" ]

        isSelected =
            Set.member name props.selectedAgents
    in
    tr [ class "agents-table-row" ]
        (( if props.bulkProviderMode then
            [ td [ class "agents-table-checkbox-col" ]
                [ input
                    [ type_ "checkbox"
                    , Html.Attributes.checked isSelected
                    , onClick (props.onToggleAgentSelected name)
                    ]
                    []
                ]
            ]
           else
            []
         )
            ++ [ td [ class "agents-table-name" ] [ text name ]
               , td [ class "agents-table-provider" ]
                    [ span
                        [ class "provider-link"
                        , onClick (props.onOpenEditForm agent)
                        ]
                        [ text providerText ]
                    ]
               , td [ class "agents-table-status" ] [ statusIcon ]
               , td [ class "agents-table-tools monospace" ] [ text toolsText ]
               , td [ class "agents-table-actions" ]
                    [ button
                        [ class "btn btn-small btn-danger"
                        , onClick (props.onDeleteAgent name)
                        ]
                        [ text "Delete" ]
                    ]
               ]
        )


viewAgentFormModal : Props msg -> Html msg
viewAgentFormModal props =
    when props.agentForm is
        Nothing ->
            text ""

        Just form ->
            div [ class "modal-overlay", onClick props.onCloseForm ]
                [ div
                    [ class "modal modal-wide"
                    , Html.Events.stopPropagationOn "click"
                        (Json.Decode.succeed
                            { message = props.onNoOp
                            , stopPropagation = True
                            }
                        )
                    ]
                    [ h2 []
                        [ text
                            (if form.isEditing then
                                "Edit Agent"
                             else
                                "Create Agent"
                            )
                        ]
                    , Html.form [ onSubmit props.onSaveAgent ]
                        [ div [ class "form-group" ]
                            [ label [ for "agent-name" ] [ text "Name" ]
                            , input
                                [ id "agent-name"
                                , type_ "text"
                                , value form.name
                                , onInput props.onUpdateName
                                , placeholder "e.g. developer"
                                , disabled form.isEditing
                                , autofocus (not form.isEditing)
                                ]
                                []
                            ]
                        , div [ class "form-group" ]
                            [ label [ for "agent-instructions" ] [ text "Instructions" ]
                            , textarea
                                [ id "agent-instructions"
                                , value form.instructions
                                , onInput props.onUpdateInstructions
                                , placeholder "Enter agent system prompt / instructions..."
                                , Html.Attributes.rows 12
                                ]
                                []
                            ]
                        , div [ class "form-group" ]
                            [ label [ for "agent-provider" ] [ text "Provider" ]
                            , select
                                [ id "agent-provider"
                                , onInput props.onUpdateProvider
                                ]
                                ([ option [ value "", selected (form.provider == "") ] [ text "-- Not Configured --" ]
                                 ]
                                    ++ Array.map
                                        (\p ->
                                            option
                                                [ value p.name
                                                , selected (form.provider == p.name)
                                                ]
                                                [ text p.name ]
                                        )
                                        props.providers
                                )
                            ]
                        , div [ class "form-group" ]
                            [ label [ for "agent-model" ] [ text "Model (optional)" ]
                            , input
                                [ id "agent-model"
                                , type_ "text"
                                , value form.model
                                , onInput props.onUpdateModel
                                , placeholder "e.g. claude-sonnet-4-5-20250929"
                                ]
                                []
                            ]
                        , div [ class "form-group" ]
                            [ label [ for "agent-tools" ] [ text "Allowed Tools" ]
                            , input
                                [ id "agent-tools"
                                , type_ "text"
                                , value form.allowedTools
                                , onInput props.onUpdateAllowedTools
                                , placeholder "Comma-separated tool names"
                                ]
                                []
                            ]
                        , div [ class "form-actions" ]
                            [ button
                                [ type_ "button"
                                , class "btn btn-secondary"
                                , onClick props.onCloseForm
                                ]
                                [ text "Cancel" ]
                            , button
                                [ type_ "submit"
                                , class "btn btn-primary"
                                ]
                                [ text
                                    (if form.isEditing then
                                        "Update"
                                     else
                                        "Create"
                                    )
                                ]
                            ]
                        ]
                    ]
                ]
