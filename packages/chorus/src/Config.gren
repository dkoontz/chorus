module Config exposing
    ( Config
    , defaultConfig
    , configFromEnv
    )

{-| Application configuration.

Provides config types and constructors. Paths are resolved relative to a
base directory (typically the binary's parent directory) so the application
works correctly regardless of the current working directory.

-}

import Dict exposing (Dict)
import Logging exposing (LogLevel(..))


type alias Config =
    { host : String
    , serverPort : Int
    , registryRoot : String
    , workspacesRoot : String
    , staticRoot : String
    , uploadDir : String
    , agentsRoot : String
    , chorusToolsPath : String
    , logLevel : LogLevel
    , apiBaseUrl : String
    , apiKey : String
    , defaultModel : String
    }


defaultConfig : Config
defaultConfig =
    { host = "0.0.0.0"
    , serverPort = 8080
    , registryRoot = "./data/registry"
    , workspacesRoot = "./data/workspaces"
    , staticRoot = "./static"
    , uploadDir = "./data/uploads"
    , agentsRoot = "./data/agents"
    , chorusToolsPath = "./tools/chorus-tools"
    , logLevel = LogInfo
    , apiBaseUrl = ""
    , apiKey = ""
    , defaultModel = ""
    }


{-| Create configuration from environment variables.

    The `baseDir` parameter is the parent directory of the running binary,
    used to resolve default paths for static files, data, and tools relative
    to the binary location rather than the current working directory.

    Supported environment variables:
    - CHORUS_HOST: Server host (default: 0.0.0.0)
    - CHORUS_PORT: Server port (default: 8080)
    - CHORUS_DATA_DIR: Base data directory (default: <baseDir>/data)
    - CHORUS_STATIC_DIR: Static files directory (default: <baseDir>/static)
    - CHORUS_LOG_LEVEL: Log level - error, warn, info, debug (default: info)
    - CHORUS_API_BASE_URL: Base URL for OpenAI-compatible API
    - CHORUS_API_KEY: API key for the LLM provider
    - CHORUS_DEFAULT_MODEL: Default model name for API providers

-}
configFromEnv : String -> Dict String String -> Config -> Config
configFromEnv baseDir envVars config =
    let
        host =
            Dict.get "CHORUS_HOST" envVars
                |> Maybe.withDefault config.host

        serverPort =
            Dict.get "CHORUS_PORT" envVars
                |> Maybe.andThen String.toInt
                |> Maybe.withDefault config.serverPort

        dataDir =
            Dict.get "CHORUS_DATA_DIR" envVars
                |> Maybe.withDefault (baseDir ++ "/data")

        staticRoot =
            Dict.get "CHORUS_STATIC_DIR" envVars
                |> Maybe.withDefault (baseDir ++ "/static")

        logLevel =
            Dict.get "CHORUS_LOG_LEVEL" envVars
                |> Maybe.andThen Logging.parseLogLevel
                |> Maybe.withDefault config.logLevel

        uploadDir =
            Dict.get "CHORUS_UPLOAD_DIR" envVars
                |> Maybe.withDefault (dataDir ++ "/uploads")
    in
    { host = host
    , serverPort = serverPort
    , registryRoot = dataDir ++ "/registry"
    , workspacesRoot = dataDir ++ "/workspaces"
    , staticRoot = staticRoot
    , uploadDir = uploadDir
    , agentsRoot = dataDir ++ "/agents"
    , chorusToolsPath = Dict.get "CHORUS_TOOLS_PATH" envVars |> Maybe.withDefault (baseDir ++ "/tools/chorus-tools")
    , logLevel = logLevel
    , apiBaseUrl = Dict.get "CHORUS_API_BASE_URL" envVars |> Maybe.withDefault config.apiBaseUrl
    , apiKey = Dict.get "CHORUS_API_KEY" envVars |> Maybe.withDefault config.apiKey
    , defaultModel = Dict.get "CHORUS_DEFAULT_MODEL" envVars |> Maybe.withDefault config.defaultModel
    }
