module Agent.Registry exposing
    ( AgentRegistry
    , Error(..)
    , init
    , getAgent
    , listAgents
    , updateAgent
    , deleteAgent
    , errorToString
    )

{-| File-based agent configuration registry.

Agent configs are stored as individual JSON files in `data/agents/{name}.json`.
On first run (empty directory), default configs are seeded.

-}

import Bytes
import Dict exposing (Dict)
import FileSystem
import FileSystem.Path as Path exposing (Path)
import Json.Decode as Decode exposing (Decoder)
import Json.Encode as Encode
import Task as GrenTask
import Types exposing (AgentConfig(..), AgentProvider(..), encodeAgentConfig, agentConfigDecoder)


-- TYPES


{-| Handle to the agent registry. Contains the filesystem permission and root path.
-}
type AgentRegistry
    = AgentRegistry
        { filesystemPermission : FileSystem.Permission
        , agentsRoot : Path
        }


{-| Errors that can occur during registry operations.
-}
type Error
    = FileSystemError String
    | JsonDecodeError String
    | AgentNotFound String



-- INITIALIZATION


{-| Initialize the agent registry.

Creates `data/agents/` if missing, seeds default configs when the directory is empty.
-}
init : FileSystem.Permission -> { agentsRoot : String } -> GrenTask.Task Error AgentRegistry
init filesystemPermission config =
    let
        agentsPath =
            Path.fromPosixString config.agentsRoot

        registry =
            AgentRegistry
                { filesystemPermission = filesystemPermission
                , agentsRoot = agentsPath
                }
    in
    ensureDirectoryExists filesystemPermission agentsPath
        |> GrenTask.andThen (\_ -> seedDefaultsIfEmpty filesystemPermission agentsPath)
        |> GrenTask.map (\_ -> registry)


{-| Ensure a directory exists, creating it if necessary.
-}
ensureDirectoryExists : FileSystem.Permission -> Path -> GrenTask.Task Error {}
ensureDirectoryExists filesystemPermission path =
    FileSystem.makeDirectory filesystemPermission { recursive = True } path
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.map (\_ -> {})


{-| Seed default agent configs if the agents directory is empty or contains
files that cannot be decoded (e.g. from a previous format).
-}
seedDefaultsIfEmpty : FileSystem.Permission -> Path -> GrenTask.Task Error {}
seedDefaultsIfEmpty filesystemPermission agentsPath =
    FileSystem.listDirectory filesystemPermission agentsPath
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.andThen
            (\entries ->
                let
                    jsonFilePaths =
                        entries
                            |> Array.keepIf (\entry -> String.endsWith ".json" (Path.toPosixString entry.path))
                            |> Array.map (\entry -> Path.append entry.path agentsPath)
                in
                if Array.isEmpty jsonFilePaths then
                    seedDefaults filesystemPermission agentsPath
                else
                    validateExistingFiles filesystemPermission agentsPath jsonFilePaths
            )


{-| Try to decode each existing agent file. If any file fails to decode,
delete all agent files and re-seed from defaults.
-}
validateExistingFiles : FileSystem.Permission -> Path -> Array Path -> GrenTask.Task Error {}
validateExistingFiles filesystemPermission agentsPath filePaths =
    filePaths
        |> Array.foldl
            (\filePath acc ->
                acc
                    |> GrenTask.andThen
                        (\allValid ->
                            readAgentConfigFile filesystemPermission filePath
                                |> GrenTask.map (\_ -> allValid)
                                |> GrenTask.onError
                                    (\err ->
                                        when err is
                                            JsonDecodeError _ ->
                                                GrenTask.succeed False

                                            _ ->
                                                GrenTask.fail err
                                    )
                        )
            )
            (GrenTask.succeed True)
        |> GrenTask.andThen
            (\allValid ->
                if allValid then
                    GrenTask.succeed {}
                else
                    deleteFiles filesystemPermission filePaths
                        |> GrenTask.andThen (\_ -> seedDefaults filesystemPermission agentsPath)
            )


{-| Delete a list of files.
-}
deleteFiles : FileSystem.Permission -> Array Path -> GrenTask.Task Error {}
deleteFiles filesystemPermission filePaths =
    filePaths
        |> Array.foldl
            (\filePath acc ->
                acc
                    |> GrenTask.andThen
                        (\_ ->
                            FileSystem.remove filesystemPermission { recursive = False } filePath
                                |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
                                |> GrenTask.map (\_ -> {})
                        )
            )
            (GrenTask.succeed {})


{-| Write default configs for all known agents.
-}
seedDefaults : FileSystem.Permission -> Path -> GrenTask.Task Error {}
seedDefaults filesystemPermission agentsPath =
    let
        defaults =
            [ Types.UserDefinedAgent
                { name = "researcher"
                , instructions = researcherInstructions
                , allowedTools = [ "web.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.UserDefinedAgent
                { name = "planner"
                , instructions = plannerInstructions
                , allowedTools = [ "file.read", "file.write", "file.create", "file.patch", "file.list", "file.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.UserDefinedAgent
                { name = "writer-workflow"
                , instructions = writerWorkflowInstructions
                , allowedTools = [ "handoff", "file.read", "file.list", "file.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.UserDefinedAgent
                { name = "writer"
                , instructions = writerInstructions
                , allowedTools = [ "file.read", "file.write", "file.create", "file.patch", "file.list", "file.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.UserDefinedAgent
                { name = "editor"
                , instructions = editorInstructions
                , allowedTools = [ "file.read", "file.list", "file.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.UserDefinedAgent
                { name = "fact-checker"
                , instructions = factCheckerInstructions
                , allowedTools = [ "file.read", "file.list", "file.search", "web.search" ]
                , provider = NotConfigured
                , model = Nothing
                }
            , Types.InternalAgent
                { name = "task-validator"
                , instructions = taskValidatorInstructions
                }
            ]
    in
    defaults
        |> Array.foldl
            (\config acc ->
                acc
                    |> GrenTask.andThen (\_ -> writeAgentConfig filesystemPermission agentsPath config)
            )
            (GrenTask.succeed {})


researcherInstructions : String
researcherInstructions =
    "# Researcher Agent\n\nYou are a researcher agent responsible for investigating topics and producing structured research findings.\n\n## Your Approach\n\n1. **Understand the topic** - Read the task description to understand what needs to be researched\n2. **Identify key questions** - Break the topic into specific questions that need answers\n3. **Gather information** - Search for relevant information, read source materials, collect data\n4. **Evaluate sources** - Assess the reliability and relevance of what you found\n5. **Synthesize findings** - Organize information into a coherent narrative\n6. **Present your findings** - Deliver a structured summary of what you learned\n\n## Research Guidelines\n\n- Focus on answering the specific questions identified, not tangential topics\n- Note where sources agree and where they conflict\n- Distinguish between facts, expert opinions, and speculation\n- Flag any gaps where you could not find reliable information\n- Cite sources where possible so findings can be verified\n\n## Important\n\n- Be thorough but focused - research the topic, not everything adjacent to it\n- Be honest about what you could and could not find\n- Do not fabricate sources or findings\n- If the topic is too broad, narrow it to the most relevant aspects and note what was excluded"


plannerInstructions : String
plannerInstructions =
    "# Planner Agent\n\nYou are a planner agent responsible for helping break down goals into well-defined, actionable plans.\n\n## Your Approach\n\n1. **Understand the request** - Read the task description\n2. **Identify unknowns** - Determine what information is missing\n3. **Draft the plan** - Define the goal, steps, and success criteria\n4. **Present the plan** - Deliver a structured breakdown\n\n## What to Consider\n\n### Goal\n- What is the desired end result?\n- Who is the audience or beneficiary?\n- What does success look like?\n\n### Scope\n- What specifically should be included?\n- What should NOT be included? (boundaries)\n- Are there related activities that might be affected?\n\n### Constraints\n- Are there deadlines, length requirements, or format requirements?\n- Are there dependencies on other work or information?\n- Are there preferences for approach or style?\n\n### Success Criteria\n- How will we know this is complete?\n- What are the must-haves vs nice-to-haves?\n- Are there quality standards to meet?\n\n## Important\n\n- Do NOT make assumptions about requirements - note what is unclear\n- Be specific in success criteria - vague criteria lead to incomplete work\n- Keep the plan focused - if scope is too large, suggest breaking into multiple tasks"


writerWorkflowInstructions : String
writerWorkflowInstructions =
    "# Writer Workflow\n\nYou are the writer workflow orchestrator responsible for coordinating the writing process. You do NOT write content directly - you hand off to other agents and make decisions based on their results.\n\n## Workflow Phases\n\n```\n[research] -> write -> edit -> fact-check -> COMPLETE\n                ^       |        |\n                |       v        |\n                +-------+--------+\n                (on failure, return to write, then back through edit)\n```\n\nResearch is optional - only needed if the task requires gathering information.\n\nAll paths back to `write` must proceed through `edit` before returning to `fact-check`. The editor must verify revisions before fact-checking re-runs.\n\n### Research\n- Determine if research is needed based on the task\n- Research IS needed if the task involves topics requiring background, factual claims, or synthesis of external information\n- Research is NOT needed for creative writing, opinion content, or reformatting\n- If needed, hand off to the Researcher agent\n\n### Write\n- Hand off to the Writer agent\n- After completion, always proceed to edit\n\n### Edit\n- Hand off to the Editor agent\n- If CHANGES REQUESTED -> return to write\n- If APPROVED -> proceed to fact-check\n\n### Fact-Check\n- Hand off to the Fact-Checker agent\n- If FAIL -> return to write (which will then go through edit again)\n- If PASS -> complete\n\n## Decision Rules\n\n1. **Max Iterations**: If iteration count reaches 5, stop and report the recurring issues\n2. **Research Decision**: When in doubt, do the research\n3. **Editor Authority**: Any issue marked MUST FIX means CHANGES REQUESTED\n4. **Fact-Check Failures**: Any HIGH severity inaccuracy or unverifiable claim means FAIL\n5. **Edit Required After Write**: The flow is always write -> edit -> fact-check, never skip edit\n\n## Important\n\n- You coordinate, you do NOT write content. Never draft or edit text directly.\n- If stuck in a loop (same issue recurring), escalate to the user with details"


writerInstructions : String
writerInstructions =
    "# Writer Agent\n\nYou are a writer agent responsible for producing and revising written content based on a task description.\n\n## Your Approach\n\n1. **Understand the task** - Read the task description to understand what needs to be written\n2. **Incorporate research** if provided - weave findings naturally into the content\n3. **Address feedback** if this is a revision - make targeted changes based on editor or fact-check feedback\n4. **Write or revise the content** following the task requirements\n5. **Self-assess** - Review your own work against the stated requirements\n\n## Writing Guidelines\n\n- Follow any format, style, or length requirements from the task description\n- Keep the content focused on what was requested - do not add unrequested sections\n- If research findings are provided, incorporate them naturally - do not just list facts\n- When revising, make targeted changes to address feedback rather than rewriting everything\n- If requirements are ambiguous, make the choice that best serves the stated audience\n\n## Revision Guidelines\n\nWhen addressing editor feedback:\n- Fix every issue marked as MUST FIX\n- Consider suggestions but use your judgment on whether they improve the piece\n\nWhen addressing fact-check failures:\n- Correct any inaccurate claims\n- Add qualifiers or citations where claims were unverifiable\n- Remove claims that cannot be supported\n\n## Important\n\n- Be honest in your self-assessment - it helps the editor focus their review\n- If you cannot meet a requirement, explain why rather than silently skipping it"


editorInstructions : String
editorInstructions =
    "# Editor Agent\n\nYou are an editor agent responsible for reviewing written content for quality, clarity, and effectiveness.\n\n## Your Approach\n\n1. **Understand the requirements** - Read the task description to understand the goals and audience\n2. **Review the content** - Evaluate against the criteria below\n3. **Deliver your assessment** - Provide a clear APPROVED or CHANGES REQUESTED decision with specifics\n\n## Review Criteria\n\n### 1. Task Alignment\n- Does the content fulfill the stated requirements?\n- Is anything required missing or anything unrequested added?\n\n### 2. Structure and Flow\n- Is the content organized logically?\n- Do sections flow naturally from one to the next?\n\n### 3. Clarity\n- Is the writing clear and easy to understand?\n- Are complex ideas explained well?\n- Is jargon appropriate for the audience?\n\n### 4. Tone and Voice\n- Is the tone appropriate for the audience and purpose?\n- Is the voice consistent throughout?\n\n### 5. Conciseness\n- Is there unnecessary repetition?\n- Does every section earn its place?\n\n### 6. Completeness\n- Are arguments or points fully developed?\n- Are there gaps that would leave the reader with unanswered questions?\n\n## Severity Levels\n\n- **MUST FIX**: Must be addressed before the content is acceptable. Includes factual errors, missing required sections, structural problems, or inappropriate tone.\n- **SUGGESTION**: Worth considering but not required. Style preferences, alternative phrasings, minor improvements.\n\n## Important\n\n- Focus on substantive issues, not nitpicks\n- Every must-fix issue must have a clear explanation of why it matters\n- Provide specific, actionable suggestions - not just \"this could be better\"\n- Read the actual content, not just the writer's description of it\n- Consider the intended audience when evaluating tone and clarity"


factCheckerInstructions : String
factCheckerInstructions =
    "# Fact-Checker Agent\n\nYou are a fact-checker agent responsible for verifying the accuracy of claims and information in written content.\n\n## Your Approach\n\n1. **Understand the context** - Read the task description to understand the content's purpose\n2. **Review the content** - Read through the written material\n3. **Identify verifiable claims** - Find all statements that can be checked\n4. **Verify each claim** against reliable sources\n5. **Check internal consistency** - Look for contradictions within the content\n6. **Deliver your assessment** - Provide a clear PASS or FAIL decision with specifics\n\n## What to Check\n\n### Factual Claims\n- Statistics, numbers, dates, and measurements\n- Attributed quotes or paraphrases\n- Historical events or scientific facts\n- Named entities (people, organizations, places)\n\n### Logical Consistency\n- Do conclusions follow from the presented evidence?\n- Are comparisons fair and like-for-like?\n- Are there logical fallacies or unsupported leaps?\n\n### Internal Consistency\n- Do different sections of the content contradict each other?\n- Are terms used consistently throughout?\n- Do numbers add up (e.g., percentages totaling 100%)?\n\n### Source Quality\n- If the content cites sources, are they reliable?\n- Are claims attributed to appropriate authorities?\n- Is there over-reliance on a single source?\n\n## What NOT to Check\n\n- Style, tone, or writing quality (that's the editor's job)\n- Whether the content fulfills the task requirements (also the editor's job)\n- Opinions clearly marked as opinions\n- Hypothetical scenarios or thought experiments\n- Creative or fictional content (unless it contains embedded factual claims)\n\n## Severity Levels\n\n- **HIGH**: Factual error, misleading claim, or unverifiable assertion presented as fact. The content would misinform the reader.\n- **MEDIUM**: Claim that is technically correct but presented in a misleading way, or a source that is questionable but not wrong.\n- **LOW**: Minor imprecision that does not materially affect the reader's understanding.\n\n## Important\n\n- Check claims against reliable sources, not just your own knowledge\n- Be precise about what is wrong - explain what the correct information is\n- Do not flag opinions as inaccurate - flag them only if they are presented as facts\n- A single HIGH severity issue means overall FAIL\n- If the content makes no factual claims (e.g., pure creative writing), note this and PASS\n- When a claim is unverifiable, recommend that the writer either find a source, add a qualifier, or remove it"

taskValidatorInstructions : String
taskValidatorInstructions =
    "# Task Validator\n\nYou are the task validation agent. Analyze task descriptions and produce a structured plan.\n\nYou MUST submit your result using the planner-output tool via the chorus-tools CLI. Choose ONE of these formats:\n\n## Format 1: Plan (when you have enough information)\n\nInvoke via Bash:\nchorus-tools <workspace-root> '{\"tool\": \"planner-output\", \"type\": \"plan\", \"summary\": \"Brief summary of what the task involves\", \"requirements\": [\"Requirement 1\", \"Requirement 2\"], \"acceptanceCriteria\": [\"Criterion 1\", \"Criterion 2\"], \"plan\": [\"Step 1\", \"Step 2\", \"Step 3\"], \"assignedAgent\": \"writer\"}'\n\n## Format 2: Questions (when you need clarification)\n\nInvoke via Bash:\nchorus-tools <workspace-root> '{\"tool\": \"planner-output\", \"type\": \"questions\", \"questions\": [\"Question 1?\", \"Question 2?\"]}'\n\n## Guidelines\n\n- Read the task description carefully\n- If the task is clear enough to plan, produce a plan\n- If key details are missing, ask questions\n- The `assignedAgent` must be a real agent name (not `task-validator`)\n- Keep plans concise and actionable\n- Tools are invoked via the chorus-tools CLI binary through Bash, NOT as native function calls\n- You MUST call the planner-output tool exactly once before finishing"


-- OPERATIONS


{-| Get an agent config by name. Fails with AgentNotFound if the agent does not exist.
-}
getAgent : AgentRegistry -> String -> GrenTask.Task Error AgentConfig
getAgent (AgentRegistry config) name =
    let
        filePath =
            Path.append (Path.fromPosixString (name ++ ".json")) config.agentsRoot
    in
    readAgentConfigFile config.filesystemPermission filePath
        |> GrenTask.onError
            (\err ->
                when err is
                    FileSystemError msg ->
                        if String.contains "ENOENT" msg || String.contains "no such file" msg then
                            GrenTask.fail (AgentNotFound name)
                        else
                            GrenTask.fail err

                    _ ->
                        GrenTask.fail err
            )


{-| List all agent configs by reading all .json files in the agents directory.
-}
listAgents : AgentRegistry -> GrenTask.Task Error (Array AgentConfig)
listAgents (AgentRegistry config) =
    FileSystem.listDirectory config.filesystemPermission config.agentsRoot
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.andThen
            (\entries ->
                let
                    jsonFiles =
                        entries
                            |> Array.keepIf (\entry -> String.endsWith ".json" (Path.toPosixString entry.path))
                in
                jsonFiles
                    |> Array.foldl
                        (\entry acc ->
                            acc
                                |> GrenTask.andThen
                                    (\configs ->
                                        let
                                            filePath =
                                                Path.append entry.path config.agentsRoot
                                        in
                                        readAgentConfigFile config.filesystemPermission filePath
                                            |> GrenTask.map (\agentConfig -> Array.pushLast agentConfig configs)
                                    )
                        )
                        (GrenTask.succeed [])
            )


{-| Create or update an agent config.
-}
updateAgent : AgentRegistry -> AgentConfig -> GrenTask.Task Error AgentConfig
updateAgent (AgentRegistry config) agentConfig =
    writeAgentConfig config.filesystemPermission config.agentsRoot agentConfig
        |> GrenTask.map (\_ -> agentConfig)


{-| Delete an agent config by name.
-}
deleteAgent : AgentRegistry -> String -> GrenTask.Task Error {}
deleteAgent (AgentRegistry config) name =
    let
        filePath =
            Path.append (Path.fromPosixString (name ++ ".json")) config.agentsRoot
    in
    FileSystem.remove config.filesystemPermission { recursive = False } filePath
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.map (\_ -> {})
        |> GrenTask.onError
            (\err ->
                when err is
                    FileSystemError msg ->
                        if String.contains "ENOENT" msg || String.contains "no such file" msg then
                            GrenTask.fail (AgentNotFound name)
                        else
                            GrenTask.fail err

                    _ ->
                        GrenTask.fail err
            )



-- HELPERS


{-| Convert an error to a string.
-}
errorToString : Error -> String
errorToString err =
    when err is
        FileSystemError msg ->
            "File system error: " ++ msg

        JsonDecodeError msg ->
            "JSON decode error: " ++ msg

        AgentNotFound name ->
            "Agent not found: " ++ name


{-| Write a single agent config file.
-}
writeAgentConfig : FileSystem.Permission -> Path -> AgentConfig -> GrenTask.Task Error {}
writeAgentConfig filesystemPermission agentsPath agentConfig =
    let
        name =
            Types.agentConfigName agentConfig

        filePath =
            Path.append (Path.fromPosixString (name ++ ".json")) agentsPath

        json =
            encodeAgentConfig agentConfig
                |> Encode.encode 2

        bytes =
            Bytes.fromString json
    in
    FileSystem.writeFile filesystemPermission bytes filePath
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.map (\_ -> {})


{-| Read and decode an agent config from a file path.
-}
readAgentConfigFile : FileSystem.Permission -> Path -> GrenTask.Task Error AgentConfig
readAgentConfigFile filesystemPermission filePath =
    FileSystem.readFile filesystemPermission filePath
        |> GrenTask.mapError (\e -> FileSystemError (FileSystem.errorToString e))
        |> GrenTask.andThen
            (\bytes ->
                when Bytes.toString bytes is
                    Nothing ->
                        GrenTask.fail (JsonDecodeError "Could not decode agent config file as UTF-8")

                    Just content ->
                        when Decode.decodeString agentConfigDecoder content is
                            Ok agentConfig ->
                                GrenTask.succeed agentConfig

                            Err err ->
                                GrenTask.fail (JsonDecodeError (Decode.errorToString err))
            )
