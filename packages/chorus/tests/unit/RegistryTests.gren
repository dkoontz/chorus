module RegistryTests exposing (tests)

{-| Unit tests for Task.Registry module.
-}

import Id
import Json.Decode as Decode
import Json.Encode as Encode
import Task
import Types exposing (Task(..), TaskStatus(..), AgentConfig(..), AgentProvider(..), SourceInfo, Attachment, HandoffRecord)
import Time


tests : Array { name : String, run : Task.Task String {} }
tests =
    [ testTaskEncodeDecode
    , testStatusPending
    , testStatusActive
    , testStatusFailed
    , testSourceInfoEncodeDecode
    , testAttachmentRoundTrip
    , testMalformedAttachmentMissingField
    , testMalformedAttachmentWrongType
    , testMissingTaskTypeFieldFails
    , testTaskEncodeDecodeWithPlanningFields
    , testDescriptionOnlyRoundTrip
    , testHandoffRecordEncodeDecode
    , testHandoffRecordWithNothingCompletedAtEncodeDecode
    , testTaskWithHandoffFieldsEncodeDecode
    , testPlannedTaskWithHandoffFieldsEncodeDecode
    , testPlanTaskCarriesHandoffFields
    , testTaskCurrentAgentAccessor
    , testTaskAgentChainAccessor
    , testSetCurrentAgentMutator
    , testSetAgentChainMutator
    , testInternalAgentEncodeDecode
    , testUserDefinedAgentEncodeDecodeWithoutModel
    , testUserDefinedAgentEncodeDecodeWithModel
    , testUnknownAgentTypeFailsToDecode
    , testAgentConfigNameInternal
    , testAgentConfigNameUserDefined
    , testIsInternalAgentTrue
    , testIsInternalAgentFalse
    ]


-- TEST HELPERS


{-| Create a TaskId for testing. Crashes if the string is empty.
-}
testTaskId : String -> Id.TaskId
testTaskId raw =
    when Id.taskIdFromString raw is
        Just taskId ->
            taskId

        Nothing ->
            Debug.todo ("Invalid test TaskId: " ++ raw)


{-| Create a SessionId for testing. Crashes if the string is empty.
-}
testSessionId : String -> Id.SessionId
testSessionId raw =
    when Id.sessionIdFromString raw is
        Just sid ->
            sid

        Nothing ->
            Debug.todo ("Invalid test SessionId: " ++ raw)


expectEqual : a -> a -> Task.Task String {}
expectEqual expected actual =
    if expected == actual then
        Task.succeed {}
    else
        Task.fail
            ("Expected: "
                ++ Debug.toString expected
                ++ "\nActual: "
                ++ Debug.toString actual
            )


-- TESTS


testTaskEncodeDecode : { name : String, run : Task.Task String {} }
testTaskEncodeDecode =
    { name = "Task encodes and decodes correctly"
    , run =
        let
            task =
                DescriptionOnly
                    { id = testTaskId "test-id-123"
                    , description = "Test Task"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testStatusPending : { name : String, run : Task.Task String {} }
testStatusPending =
    { name = "Pending status encodes and decodes"
    , run =
        testStatusRoundTrip Pending
    }


testStatusActive : { name : String, run : Task.Task String {} }
testStatusActive =
    { name = "Active status encodes and decodes"
    , run =
        testStatusRoundTrip Active
    }


testStatusFailed : { name : String, run : Task.Task String {} }
testStatusFailed =
    { name = "Failed status encodes and decodes with message"
    , run =
        testStatusRoundTrip (Failed "Something went wrong")
    }


testStatusRoundTrip : TaskStatus -> Task.Task String {}
testStatusRoundTrip status =
    let
        task =
            DescriptionOnly
                { id = testTaskId "test"
                , description = "Test"
                , status = status
                , createdAt = Time.millisToPosix 0
                , updatedAt = Time.millisToPosix 0
                , sessionId = Nothing
                , source =
                    { sourceType = "test"
                    , userId = "test"
                    , conversationId = Nothing
                    }
                , attachments = []
                , currentAgent = Nothing
                , agentChain = []
                }

        encoded =
            Types.encodeTask task

        json =
            Encode.encode 0 encoded

        decoded =
            Decode.decodeString Types.taskDecoder json
    in
    when decoded is
        Ok decodedTask ->
            expectEqual status (Types.taskStatus decodedTask)

        Err err ->
            Task.fail ("Decode failed: " ++ Decode.errorToString err)


testSourceInfoEncodeDecode : { name : String, run : Task.Task String {} }
testSourceInfoEncodeDecode =
    { name = "SourceInfo with conversationId encodes and decodes"
    , run =
        let
            task =
                DescriptionOnly
                    { id = testTaskId "test"
                    , description = "Test"
                    , status = Pending
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Just (testSessionId "session-123")
                    , source =
                        { sourceType = "xmpp"
                        , userId = "user@example.com"
                        , conversationId = Just "thread-456"
                        }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                if Types.taskSessionId decodedTask == Just (testSessionId "session-123") && (Types.taskSource decodedTask).conversationId == Just "thread-456" then
                    Task.succeed {}
                else
                    Task.fail "sessionId or conversationId mismatch"

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testAttachmentRoundTrip : { name : String, run : Task.Task String {} }
testAttachmentRoundTrip =
    { name = "Task with attachments encodes and decodes correctly"
    , run =
        let
            attachment1 =
                { filename = "readme.md"
                , size = 1024
                , contentType = "text/markdown"
                , uploadedAt = Time.millisToPosix 1707048700000
                }

            attachment2 =
                { filename = "data.csv"
                , size = 2048
                , contentType = "text/csv"
                , uploadedAt = Time.millisToPosix 1707048800000
                }

            task =
                DescriptionOnly
                    { id = testTaskId "test-attach"
                    , description = "Task with attachments"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = [ attachment1, attachment2 ]
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                let
                    decodedAttachments =
                        Types.taskAttachments decodedTask
                in
                expectEqual 2 (Array.length decodedAttachments)
                    |> Task.andThen
                        (\_ ->
                            when Array.first decodedAttachments is
                                Just a ->
                                    expectEqual "readme.md" a.filename
                                        |> Task.andThen (\_ -> expectEqual 1024 a.size)
                                        |> Task.andThen (\_ -> expectEqual "text/markdown" a.contentType)
                                        |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 1707048700000) a.uploadedAt)

                                Nothing ->
                                    Task.fail "First attachment was Nothing"
                        )
                    |> Task.andThen
                        (\_ ->
                            when Array.get 1 decodedAttachments is
                                Just a ->
                                    expectEqual "data.csv" a.filename
                                        |> Task.andThen (\_ -> expectEqual 2048 a.size)
                                        |> Task.andThen (\_ -> expectEqual "text/csv" a.contentType)
                                        |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 1707048800000) a.uploadedAt)

                                Nothing ->
                                    Task.fail "Second attachment was Nothing"
                        )

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testMalformedAttachmentMissingField : { name : String, run : Task.Task String {} }
testMalformedAttachmentMissingField =
    { name = "Task with malformed attachment fails to decode"
    , run =
        let
            -- Attachment is missing the "contentType" field.
            json =
                "{\"taskType\":\"description_only\",\"id\":\"bad-task\",\"description\":\"Bad\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[{\"filename\":\"f.txt\",\"size\":100,\"uploadedAt\":0}]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testMalformedAttachmentWrongType : { name : String, run : Task.Task String {} }
testMalformedAttachmentWrongType =
    { name = "Task with wrong attachment field type fails to decode"
    , run =
        let
            -- Attachment "size" is a string instead of an int.
            json =
                "{\"taskType\":\"description_only\",\"id\":\"bad-task\",\"description\":\"Bad\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[{\"filename\":\"f.txt\",\"size\":\"not-a-number\",\"contentType\":\"text/plain\",\"uploadedAt\":0}]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testMissingTaskTypeFieldFails : { name : String, run : Task.Task String {} }
testMissingTaskTypeFieldFails =
    { name = "Task JSON without taskType field fails to decode"
    , run =
        let
            json =
                "{\"id\":\"no-type\",\"description\":\"Missing taskType\",\"status\":{\"type\":\"pending\"},\"createdAt\":0,\"updatedAt\":0,\"sessionId\":null,\"source\":{\"sourceType\":\"test\",\"userId\":\"test\",\"conversationId\":null},\"agentWorkspace\":\"/tmp\",\"attachments\":[]}"

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testTaskEncodeDecodeWithPlanningFields : { name : String, run : Task.Task String {} }
testTaskEncodeDecodeWithPlanningFields =
    { name = "Task with planning fields encodes and decodes correctly"
    , run =
        let
            task =
                Planned
                    { id = testTaskId "plan-task-1"
                    , description = "Task with planning data"
                    , status = Pending
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    , summary = "Build a REST API for task management"
                    , requirements = [ "Support CRUD operations", "Use JSON format" ]
                    , acceptanceCriteria = [ "All endpoints return valid JSON", "Error responses include error codes" ]
                    , plan = [ "Define data types", "Implement handlers", "Add tests" ]
                    , questions = []
                    , assignedAgent = Nothing
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testDescriptionOnlyRoundTrip : { name : String, run : Task.Task String {} }
testDescriptionOnlyRoundTrip =
    { name = "DescriptionOnly task round-trips correctly"
    , run =
        let
            task =
                DescriptionOnly
                    { id = testTaskId "desc-only"
                    , description = "Simple task"
                    , status = Active
                    , createdAt = Time.millisToPosix 1707048600000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Just (testSessionId "sess-1")
                    , source =
                        { sourceType = "web"
                        , userId = "user1"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual task decodedTask

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testHandoffRecordEncodeDecode : { name : String, run : Task.Task String {} }
testHandoffRecordEncodeDecode =
    { name = "HandoffRecord encodes and decodes correctly"
    , run =
        let
            record =
                { agentName = "writer"
                , startedAt = Time.millisToPosix 1707048600000
                , completedAt = Just (Time.millisToPosix 1707048700000)
                , input = "Write the implementation"
                , output = "Implementation complete"
                , completionReport = Nothing
                }

            encoded =
                Types.encodeHandoffRecord record

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.handoffRecordDecoder json
        in
        when decoded is
            Ok decodedRecord ->
                expectEqual record.agentName decodedRecord.agentName
                    |> Task.andThen (\_ -> expectEqual record.startedAt decodedRecord.startedAt)
                    |> Task.andThen (\_ -> expectEqual record.completedAt decodedRecord.completedAt)
                    |> Task.andThen (\_ -> expectEqual record.input decodedRecord.input)
                    |> Task.andThen (\_ -> expectEqual record.output decodedRecord.output)

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testHandoffRecordWithNothingCompletedAtEncodeDecode : { name : String, run : Task.Task String {} }
testHandoffRecordWithNothingCompletedAtEncodeDecode =
    { name = "HandoffRecord with completedAt=Nothing encodes and decodes"
    , run =
        let
            record =
                { agentName = "editor"
                , startedAt = Time.millisToPosix 1707048600000
                , completedAt = Nothing
                , input = ""
                , output = ""
                , completionReport = Nothing
                }

            encoded =
                Types.encodeHandoffRecord record

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.handoffRecordDecoder json
        in
        when decoded is
            Ok decodedRecord ->
                expectEqual record.agentName decodedRecord.agentName
                    |> Task.andThen (\_ -> expectEqual record.startedAt decodedRecord.startedAt)
                    |> Task.andThen (\_ -> expectEqual Nothing decodedRecord.completedAt)
                    |> Task.andThen (\_ -> expectEqual "" decodedRecord.output)

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testTaskWithHandoffFieldsEncodeDecode : { name : String, run : Task.Task String {} }
testTaskWithHandoffFieldsEncodeDecode =
    { name = "Task with populated handoff fields encodes and decodes"
    , run =
        let
            handoffRecord =
                { agentName = "writer"
                , startedAt = Time.millisToPosix 1707048600000
                , completedAt = Just (Time.millisToPosix 1707048700000)
                , input = "Do something"
                , output = "Done"
                , completionReport = Nothing
                }

            task =
                DescriptionOnly
                    { id = testTaskId "handoff-test"
                    , description = "Test handoff fields"
                    , status = Active
                    , createdAt = Time.millisToPosix 1707048500000
                    , updatedAt = Time.millisToPosix 1707048700000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Just "editor"
                    , agentChain = [ handoffRecord ]
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual (Just "editor") (Types.taskCurrentAgent decodedTask)
                    |> Task.andThen (\_ -> expectEqual 1 (Array.length (Types.taskAgentChain decodedTask)))
                    |> Task.andThen
                        (\_ ->
                            when Array.first (Types.taskAgentChain decodedTask) is
                                Just r ->
                                    expectEqual "writer" r.agentName
                                        |> Task.andThen (\_ -> expectEqual "Done" r.output)

                                Nothing ->
                                    Task.fail "Expected one handoff record in agentChain"
                        )

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testPlannedTaskWithHandoffFieldsEncodeDecode : { name : String, run : Task.Task String {} }
testPlannedTaskWithHandoffFieldsEncodeDecode =
    { name = "Planned task with handoff fields encodes and decodes"
    , run =
        let
            handoffRecord =
                { agentName = "writer"
                , startedAt = Time.millisToPosix 1707048600000
                , completedAt = Just (Time.millisToPosix 1707048700000)
                , input = "Implement the feature"
                , output = "Implemented"
                , completionReport = Nothing
                }

            task =
                Planned
                    { id = testTaskId "planned-handoff-test"
                    , description = "Test planned task with handoff"
                    , status = Active
                    , createdAt = Time.millisToPosix 1707048500000
                    , updatedAt = Time.millisToPosix 1707048700000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Just "writer"
                    , agentChain = [ handoffRecord ]
                    , summary = "Test summary"
                    , requirements = [ "Req 1" ]
                    , acceptanceCriteria = [ "Criteria 1" ]
                    , plan = [ "Step 1" ]
                    , questions = []
                    , assignedAgent = Nothing
                    }

            encoded =
                Types.encodeTask task

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.taskDecoder json
        in
        when decoded is
            Ok decodedTask ->
                expectEqual (Just "writer") (Types.taskCurrentAgent decodedTask)
                    |> Task.andThen (\_ -> expectEqual 1 (Array.length (Types.taskAgentChain decodedTask)))
                    |> Task.andThen (\_ -> expectEqual True (Types.isPlanned decodedTask))
                    |> Task.andThen
                        (\_ ->
                            when Array.first (Types.taskAgentChain decodedTask) is
                                Just r ->
                                    expectEqual "writer" r.agentName
                                        |> Task.andThen (\_ -> expectEqual "Implemented" r.output)

                                Nothing ->
                                    Task.fail "Expected one handoff record in agentChain"
                        )

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testPlanTaskCarriesHandoffFields : { name : String, run : Task.Task String {} }
testPlanTaskCarriesHandoffFields =
    { name = "planTask carries forward currentAgent and agentChain"
    , run =
        let
            handoffRecord =
                { agentName = "researcher"
                , startedAt = Time.millisToPosix 1707048600000
                , completedAt = Nothing
                , input = "Research the topic"
                , output = ""
                , completionReport = Nothing
                }

            descTask =
                DescriptionOnly
                    { id = testTaskId "plan-carry"
                    , description = "Test carry forward"
                    , status = Active
                    , createdAt = Time.millisToPosix 1707048500000
                    , updatedAt = Time.millisToPosix 1707048600000
                    , sessionId = Nothing
                    , source =
                        { sourceType = "terminal"
                        , userId = "testuser"
                        , conversationId = Nothing
                        }

                    , attachments = []
                    , currentAgent = Just "researcher"
                    , agentChain = [ handoffRecord ]
                    }

            planningFields =
                { summary = "Test summary"
                , requirements = [ "Req 1" ]
                , acceptanceCriteria = [ "Criteria 1" ]
                , plan = [ "Step 1" ]
                , questions = []
                , assignedAgent = Nothing
                }

            plannedTask =
                Types.planTask descTask planningFields
        in
        expectEqual (Just "researcher") (Types.taskCurrentAgent plannedTask)
            |> Task.andThen (\_ -> expectEqual 1 (Array.length (Types.taskAgentChain plannedTask)))
            |> Task.andThen
                (\_ ->
                    when Array.first (Types.taskAgentChain plannedTask) is
                        Just r ->
                            expectEqual "researcher" r.agentName

                        Nothing ->
                            Task.fail "Expected handoff record to be carried forward"
                )
    }


testTaskCurrentAgentAccessor : { name : String, run : Task.Task String {} }
testTaskCurrentAgentAccessor =
    { name = "taskCurrentAgent accessor works for both task types"
    , run =
        let
            descTask =
                DescriptionOnly
                    { id = testTaskId "t1"
                    , description = "Test"
                    , status = Pending
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Just "writer"
                    , agentChain = []
                    }

            plannedTask =
                Planned
                    { id = testTaskId "t2"
                    , description = "Test"
                    , status = Active
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Just "editor"
                    , agentChain = []
                    , summary = ""
                    , requirements = []
                    , acceptanceCriteria = []
                    , plan = []
                    , questions = []
                    , assignedAgent = Nothing
                    }
        in
        expectEqual (Just "writer") (Types.taskCurrentAgent descTask)
            |> Task.andThen (\_ -> expectEqual (Just "editor") (Types.taskCurrentAgent plannedTask))
    }


testTaskAgentChainAccessor : { name : String, run : Task.Task String {} }
testTaskAgentChainAccessor =
    { name = "taskAgentChain accessor returns correct chain"
    , run =
        let
            record1 =
                { agentName = "writer"
                , startedAt = Time.millisToPosix 100
                , completedAt = Just (Time.millisToPosix 200)
                , input = "write it"
                , output = "first"
                , completionReport = Nothing
                }

            record2 =
                { agentName = "editor"
                , startedAt = Time.millisToPosix 300
                , completedAt = Nothing
                , input = "edit it"
                , output = ""
                , completionReport = Nothing
                }

            task =
                DescriptionOnly
                    { id = testTaskId "chain-test"
                    , description = "Test"
                    , status = Active
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Just "editor"
                    , agentChain = [ record1, record2 ]
                    }
        in
        let
            chain =
                Types.taskAgentChain task
        in
        expectEqual 2 (Array.length chain)
            |> Task.andThen
                (\_ ->
                    when Array.first chain is
                        Just r ->
                            expectEqual "writer" r.agentName
                                |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 100) r.startedAt)
                                |> Task.andThen (\_ -> expectEqual (Just (Time.millisToPosix 200)) r.completedAt)
                                |> Task.andThen (\_ -> expectEqual "first" r.output)

                        Nothing ->
                            Task.fail "Expected first chain entry"
                )
            |> Task.andThen
                (\_ ->
                    when Array.get 1 chain is
                        Just r ->
                            expectEqual "editor" r.agentName
                                |> Task.andThen (\_ -> expectEqual (Time.millisToPosix 300) r.startedAt)
                                |> Task.andThen (\_ -> expectEqual Nothing r.completedAt)
                                |> Task.andThen (\_ -> expectEqual "" r.output)

                        Nothing ->
                            Task.fail "Expected second chain entry"
                )
    }


testSetCurrentAgentMutator : { name : String, run : Task.Task String {} }
testSetCurrentAgentMutator =
    { name = "setCurrentAgent mutator works correctly"
    , run =
        let
            task =
                DescriptionOnly
                    { id = testTaskId "mutator-test"
                    , description = "Test"
                    , status = Pending
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            updated =
                Types.setCurrentAgent (Just "writer") task

            cleared =
                Types.setCurrentAgent Nothing updated
        in
        expectEqual (Just "writer") (Types.taskCurrentAgent updated)
            |> Task.andThen (\_ -> expectEqual Nothing (Types.taskCurrentAgent cleared))
    }


testSetAgentChainMutator : { name : String, run : Task.Task String {} }
testSetAgentChainMutator =
    { name = "setAgentChain mutator works for both task types"
    , run =
        let
            record =
                { agentName = "writer"
                , startedAt = Time.millisToPosix 100
                , completedAt = Nothing
                , input = ""
                , output = ""
                , completionReport = Nothing
                }

            descTask =
                DescriptionOnly
                    { id = testTaskId "chain-mutator-test"
                    , description = "Test"
                    , status = Pending
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    }

            plannedTask =
                Planned
                    { id = testTaskId "chain-mutator-test-2"
                    , description = "Test"
                    , status = Active
                    , createdAt = Time.millisToPosix 0
                    , updatedAt = Time.millisToPosix 0
                    , sessionId = Nothing
                    , source = { sourceType = "test", userId = "test", conversationId = Nothing }

                    , attachments = []
                    , currentAgent = Nothing
                    , agentChain = []
                    , summary = ""
                    , requirements = []
                    , acceptanceCriteria = []
                    , plan = []
                    , questions = []
                    , assignedAgent = Nothing
                    }

            updatedDesc =
                Types.setAgentChain [ record ] descTask

            updatedPlanned =
                Types.setAgentChain [ record ] plannedTask
        in
        expectEqual 1 (Array.length (Types.taskAgentChain updatedDesc))
            |> Task.andThen
                (\_ ->
                    when Array.first (Types.taskAgentChain updatedDesc) is
                        Just r ->
                            expectEqual "writer" r.agentName

                        Nothing ->
                            Task.fail "Expected chain entry on DescriptionOnly task"
                )
            |> Task.andThen (\_ -> expectEqual 1 (Array.length (Types.taskAgentChain updatedPlanned)))
            |> Task.andThen
                (\_ ->
                    when Array.first (Types.taskAgentChain updatedPlanned) is
                        Just r ->
                            expectEqual "writer" r.agentName

                        Nothing ->
                            Task.fail "Expected chain entry on Planned task"
                )
    }


-- AGENTCONFIG TESTS


testInternalAgentEncodeDecode : { name : String, run : Task.Task String {} }
testInternalAgentEncodeDecode =
    { name = "InternalAgent encodes and decodes correctly"
    , run =
        let
            config =
                InternalAgent
                    { name = "task-validator"
                    , instructions = "Validate tasks"
                    }

            encoded =
                Types.encodeAgentConfig config

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.agentConfigDecoder json
        in
        when decoded is
            Ok decodedConfig ->
                expectEqual config decodedConfig

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testUserDefinedAgentEncodeDecodeWithoutModel : { name : String, run : Task.Task String {} }
testUserDefinedAgentEncodeDecodeWithoutModel =
    { name = "UserDefinedAgent without model encodes and decodes correctly"
    , run =
        let
            config =
                UserDefinedAgent
                    { name = "researcher"
                    , instructions = "Research topics"
                    , allowedTools = [ "web.search", "file.read" ]
                    , provider = ProviderRef "claude-code"
                    , model = Nothing
                    }

            encoded =
                Types.encodeAgentConfig config

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.agentConfigDecoder json
        in
        when decoded is
            Ok decodedConfig ->
                expectEqual config decodedConfig

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testUserDefinedAgentEncodeDecodeWithModel : { name : String, run : Task.Task String {} }
testUserDefinedAgentEncodeDecodeWithModel =
    { name = "UserDefinedAgent with model encodes and decodes correctly"
    , run =
        let
            config =
                UserDefinedAgent
                    { name = "writer"
                    , instructions = "Write content"
                    , allowedTools = [ "file.read", "file.write" ]
                    , provider = ProviderRef "openai-compat"
                    , model = Just "gpt-4"
                    }

            encoded =
                Types.encodeAgentConfig config

            json =
                Encode.encode 0 encoded

            decoded =
                Decode.decodeString Types.agentConfigDecoder json
        in
        when decoded is
            Ok decodedConfig ->
                expectEqual config decodedConfig

            Err err ->
                Task.fail ("Decode failed: " ++ Decode.errorToString err)
    }


testUnknownAgentTypeFailsToDecode : { name : String, run : Task.Task String {} }
testUnknownAgentTypeFailsToDecode =
    { name = "Unknown agent type discriminator fails to decode"
    , run =
        let
            json =
                "{\"type\":\"unknown\",\"name\":\"bad-agent\",\"instructions\":\"Bad\"}"

            decoded =
                Decode.decodeString Types.agentConfigDecoder json
        in
        when decoded is
            Ok _ ->
                Task.fail "Decode should have failed but succeeded"

            Err _ ->
                Task.succeed {}
    }


testAgentConfigNameInternal : { name : String, run : Task.Task String {} }
testAgentConfigNameInternal =
    { name = "agentConfigName returns correct name for InternalAgent"
    , run =
        let
            config =
                InternalAgent
                    { name = "task-validator"
                    , instructions = "Validate tasks"
                    }
        in
        expectEqual "task-validator" (Types.agentConfigName config)
    }


testAgentConfigNameUserDefined : { name : String, run : Task.Task String {} }
testAgentConfigNameUserDefined =
    { name = "agentConfigName returns correct name for UserDefinedAgent"
    , run =
        let
            config =
                UserDefinedAgent
                    { name = "researcher"
                    , instructions = "Research topics"
                    , allowedTools = []
                    , provider = ProviderRef "claude-code"
                    , model = Nothing
                    }
        in
        expectEqual "researcher" (Types.agentConfigName config)
    }


testIsInternalAgentTrue : { name : String, run : Task.Task String {} }
testIsInternalAgentTrue =
    { name = "isInternalAgent returns True for InternalAgent"
    , run =
        let
            config =
                InternalAgent
                    { name = "task-validator"
                    , instructions = "Validate tasks"
                    }
        in
        expectEqual True (Types.isInternalAgent config)
    }


testIsInternalAgentFalse : { name : String, run : Task.Task String {} }
testIsInternalAgentFalse =
    { name = "isInternalAgent returns False for UserDefinedAgent"
    , run =
        let
            config =
                UserDefinedAgent
                    { name = "researcher"
                    , instructions = "Research topics"
                    , allowedTools = []
                    , provider = ProviderRef "claude-code"
                    , model = Nothing
                    }
        in
        expectEqual False (Types.isInternalAgent config)
    }


