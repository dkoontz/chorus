module ConfigTests exposing (tests)

{-| Unit tests for Config module.
-}

import Config
import Dict
import Logging exposing (LogLevel(..))
import Task


tests : Array { name : String, run : Task.Task String {} }
tests =
    [ testDefaultPathsUseCwd
    , testBaseDirAppliedToStaticRoot
    , testBaseDirAppliedToToolsPath
    , testEnvVarOverridesStaticRoot
    , testEnvVarOverridesToolsPath
    , testEnvVarOverridesHost
    , testEnvVarOverridesPort
    , testEnvVarOverridesLogLevel
    , testChorusConfigEnvVar
    , testChorusConfigDefault
    , testAbsoluteBaseDir
    ]


-- TEST HELPERS


expectEqual : a -> a -> Task.Task String {}
expectEqual expected actual =
    if expected == actual then
        Task.succeed {}
    else
        Task.fail
            ("Expected: "
                ++ Debug.toString expected
                ++ "\nActual: "
                ++ Debug.toString actual
            )


-- TESTS


testDefaultPathsUseCwd : { name : String, run : Task.Task String {} }
testDefaultPathsUseCwd =
    { name = "configFromEnv with '.' baseDir uses cwd-relative paths"
    , run =
        let
            config =
                Config.configFromEnv "." Dict.empty Config.defaultConfig
        in
        expectEqual "./static" config.staticRoot
    }


testBaseDirAppliedToStaticRoot : { name : String, run : Task.Task String {} }
testBaseDirAppliedToStaticRoot =
    { name = "configFromEnv computes staticRoot relative to baseDir"
    , run =
        let
            config =
                Config.configFromEnv "/opt/app" Dict.empty Config.defaultConfig
        in
        expectEqual "/opt/app/static" config.staticRoot
    }


testBaseDirAppliedToToolsPath : { name : String, run : Task.Task String {} }
testBaseDirAppliedToToolsPath =
    { name = "configFromEnv computes chorusToolsPath relative to baseDir"
    , run =
        let
            config =
                Config.configFromEnv "/opt/app" Dict.empty Config.defaultConfig
        in
        expectEqual "/opt/app/tools/chorus-tools" config.chorusToolsPath
    }


testEnvVarOverridesStaticRoot : { name : String, run : Task.Task String {} }
testEnvVarOverridesStaticRoot =
    { name = "CHORUS_STATIC_DIR overrides baseDir-computed staticRoot"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_STATIC_DIR" "/custom/static"

            config =
                Config.configFromEnv "/opt/app" envVars Config.defaultConfig
        in
        expectEqual "/custom/static" config.staticRoot
    }


testEnvVarOverridesToolsPath : { name : String, run : Task.Task String {} }
testEnvVarOverridesToolsPath =
    { name = "CHORUS_TOOLS_PATH overrides baseDir-computed tools path"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_TOOLS_PATH" "/custom/tools/chorus-tools"

            config =
                Config.configFromEnv "/opt/app" envVars Config.defaultConfig
        in
        expectEqual "/custom/tools/chorus-tools" config.chorusToolsPath
    }


testEnvVarOverridesHost : { name : String, run : Task.Task String {} }
testEnvVarOverridesHost =
    { name = "CHORUS_HOST overrides default host"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_HOST" "127.0.0.1"

            config =
                Config.configFromEnv "." envVars Config.defaultConfig
        in
        expectEqual "127.0.0.1" config.host
    }


testEnvVarOverridesPort : { name : String, run : Task.Task String {} }
testEnvVarOverridesPort =
    { name = "CHORUS_PORT overrides default port"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_PORT" "9090"

            config =
                Config.configFromEnv "." envVars Config.defaultConfig
        in
        expectEqual 9090 config.serverPort
    }


testEnvVarOverridesLogLevel : { name : String, run : Task.Task String {} }
testEnvVarOverridesLogLevel =
    { name = "CHORUS_LOG_LEVEL overrides default log level"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_LOG_LEVEL" "debug"

            config =
                Config.configFromEnv "." envVars Config.defaultConfig
        in
        expectEqual LogDebug config.logLevel
    }


testChorusConfigEnvVar : { name : String, run : Task.Task String {} }
testChorusConfigEnvVar =
    { name = "CHORUS_CONFIG env var sets chorusConfigPath"
    , run =
        let
            envVars =
                Dict.empty
                    |> Dict.set "CHORUS_CONFIG" "/path/to/chorus.json"

            config =
                Config.configFromEnv "." envVars Config.defaultConfig
        in
        expectEqual (Just "/path/to/chorus.json") config.chorusConfigPath
    }


testChorusConfigDefault : { name : String, run : Task.Task String {} }
testChorusConfigDefault =
    { name = "chorusConfigPath defaults to Nothing when CHORUS_CONFIG not set"
    , run =
        let
            config =
                Config.configFromEnv "." Dict.empty Config.defaultConfig
        in
        expectEqual Nothing config.chorusConfigPath
    }


testAbsoluteBaseDir : { name : String, run : Task.Task String {} }
testAbsoluteBaseDir =
    { name = "Absolute baseDir produces absolute paths"
    , run =
        let
            config =
                Config.configFromEnv "/usr/local/bin" Dict.empty Config.defaultConfig
        in
        if config.staticRoot == "/usr/local/bin/static"
            && config.chorusToolsPath == "/usr/local/bin/tools/chorus-tools"
        then
            Task.succeed {}
        else
            Task.fail
                ("Expected absolute paths:\n"
                    ++ "  staticRoot: " ++ config.staticRoot ++ "\n"
                    ++ "  chorusToolsPath: " ++ config.chorusToolsPath
                )
    }
