module Tools.Validation exposing
    ( ValidPath
    , ValidationError(..)
    , AllowedDirectories
    , makeAllowedDirectories
    , validatePath
    , toPath
    , toString
    , allowedDirectoryPaths
    )

{-| Path validation for sandboxed file operations.

All file operations must go through path validation to ensure:
- Paths stay within the allowed directories
- Path traversal attacks are prevented
- Paths are normalized before use

-}

import FileSystem.Path as Path exposing (Path)


{-| A validated path that is guaranteed to be within the allowed directories.
The constructor is not exported, so validated paths can only be
created through the validatePath function.
-}
type ValidPath
    = ValidPath Path


{-| A set of allowed directories for file operations.
All operations are scoped to these directories.
-}
type AllowedDirectories
    = AllowedDirectories (Array Path)


{-| Errors that can occur during path validation.
-}
type ValidationError
    = PathTraversalAttempt { path : String, reason : String }
    | PathOutsideAllowedDirectories { path : String }
    | EmptyPath
    | NoAllowedDirectories


{-| Create allowed directories from an array of path strings.
-}
makeAllowedDirectories : Array String -> AllowedDirectories
makeAllowedDirectories pathStrs =
    AllowedDirectories (Array.map Path.fromPosixString pathStrs)


{-| Get the Paths for the allowed directories.
-}
allowedDirectoryPaths : AllowedDirectories -> Array Path
allowedDirectoryPaths (AllowedDirectories paths) =
    paths


{-| Validate a path string, ensuring it stays within the allowed directories.

This function:
1. Rejects empty paths
2. Rejects paths containing ".." components
3. Checks that at least one allowed directory exists
4. For absolute paths: validates the path falls within any allowed directory
5. For relative paths: resolves against the first allowed directory

A path is valid if it resolves within any one of the allowed directories.

Returns a ValidPath that can be used with file operations.
-}
validatePath : AllowedDirectories -> String -> Result ValidationError ValidPath
validatePath (AllowedDirectories directories) pathStr =
    let
        trimmed =
            String.trim pathStr
    in
    if String.isEmpty trimmed then
        Err EmptyPath
    else if containsTraversal trimmed then
        Err
            (PathTraversalAttempt
                { path = trimmed
                , reason = "Path contains '..' which could escape the allowed directories"
                }
            )
    else if Array.isEmpty directories then
        Err NoAllowedDirectories
    else if String.startsWith "/" trimmed then
        -- Absolute path: check if it falls within any allowed directory
        if isWithinAnyDirectory directories trimmed then
            Ok (ValidPath (Path.fromPosixString trimmed))
        else
            Err (PathOutsideAllowedDirectories { path = trimmed })
    else
        -- Relative path: resolve against the first allowed directory
        when Array.first directories is
            Just firstDir ->
                let
                    relativePath =
                        Path.fromPosixString trimmed

                    fullPath =
                        Path.append relativePath firstDir
                in
                Ok (ValidPath fullPath)

            Nothing ->
                -- Unreachable: we already checked Array.isEmpty above
                Err NoAllowedDirectories


{-| Check if an absolute path falls within any of the allowed directories.

An absolute path is within a directory if it starts with the directory path
followed by a path separator (or is exactly the directory path).
-}
isWithinAnyDirectory : Array Path -> String -> Bool
isWithinAnyDirectory directories absolutePath =
    Array.any
        (\dir ->
            let
                dirStr =
                    Path.toPosixString dir

                dirWithSlash =
                    if String.endsWith "/" dirStr then
                        dirStr
                    else
                        dirStr ++ "/"
            in
            absolutePath == dirStr || String.startsWith dirWithSlash absolutePath
        )
        directories


{-| Check if a path contains traversal patterns.
-}
containsTraversal : String -> Bool
containsTraversal pathStr =
    let
        segments =
            String.split "/" pathStr
    in
    Array.any (\s -> s == "..") segments


{-| Convert a ValidPath back to a FileSystem.Path for use with the FileSystem module.
-}
toPath : ValidPath -> Path
toPath (ValidPath path) =
    path


{-| Convert a ValidPath to a string representation.
-}
toString : ValidPath -> String
toString (ValidPath path) =
    Path.toPosixString path


{-| Convert a validation error to a human-readable string.
-}
validationErrorToString : ValidationError -> String
validationErrorToString error =
    when error is
        EmptyPath ->
            "Path cannot be empty"

        PathOutsideAllowedDirectories { path } ->
            "Path is outside all allowed directories: " ++ path

        PathTraversalAttempt { path, reason } ->
            "Invalid path '" ++ path ++ "': " ++ reason

        NoAllowedDirectories ->
            "No allowed directories configured"
