module ValidationTests exposing (suite)

import Expect
import Test exposing (Test, describe, test)
import Tools.Validation as Validation
    exposing
        ( ValidPath
        , ValidationError(..)
        , AllowedDirectories
        , makeAllowedDirectories
        , validatePath
        , toString
        )


suite : Test
suite =
    describe "Path Validation"
        [ pathTraversalTests
        , absolutePathTests
        , emptyPathTests
        , validPathTests
        , multipleDirectoriesTests
        , noAllowedDirectoriesTests
        ]


pathTraversalTests : Test
pathTraversalTests =
    describe "Path traversal prevention"
        [ test "rejects simple path traversal" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "../etc/passwd"
                in
                when result is
                    Err (PathTraversalAttempt _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathTraversalAttempt error"
        , test "rejects path traversal in middle" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "foo/../../../etc/passwd"
                in
                when result is
                    Err (PathTraversalAttempt _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathTraversalAttempt error"
        , test "rejects multiple path traversals" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "../../../../../../etc/passwd"
                in
                when result is
                    Err (PathTraversalAttempt _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathTraversalAttempt error"
        ]


absolutePathTests : Test
absolutePathTests =
    describe "Absolute path handling"
        [ test "rejects absolute path outside allowed directories" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "/etc/passwd"
                in
                when result is
                    Err (PathOutsideAllowedDirectories _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathOutsideAllowedDirectories error"
        , test "accepts absolute path within allowed directory" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "/var/chorus/workspaces/file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/var/chorus/workspaces/file.txt"

                    Err err ->
                        Expect.fail "Expected Ok but got error"
        , test "rejects absolute path that is a prefix but not a subdirectory" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/work" ]

                    result =
                        validatePath allowedDirs "/var/chorus/workspaces/file.txt"
                in
                when result is
                    Err (PathOutsideAllowedDirectories _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathOutsideAllowedDirectories error"
        ]


emptyPathTests : Test
emptyPathTests =
    describe "Empty path handling"
        [ test "rejects empty string" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs ""
                in
                when result is
                    Err EmptyPath ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected EmptyPath error"
        , test "rejects whitespace-only string" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "   "
                in
                when result is
                    Err EmptyPath ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected EmptyPath error"
        ]


validPathTests : Test
validPathTests =
    describe "Valid paths"
        [ test "accepts simple filename" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/var/chorus/workspaces/file.txt"

                    Err err ->
                        Expect.fail "Expected Ok but got error"
        , test "accepts nested path" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "src/main/file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/var/chorus/workspaces/src/main/file.txt"

                    Err err ->
                        Expect.fail "Expected Ok but got error"
        , test "accepts current directory reference" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/var/chorus/workspaces" ]

                    result =
                        validatePath allowedDirs "./file.txt"
                in
                when result is
                    Ok _ ->
                        Expect.pass

                    Err err ->
                        Expect.fail "Expected Ok but got error"
        ]


multipleDirectoriesTests : Test
multipleDirectoriesTests =
    describe "Multiple allowed directories"
        [ test "relative path resolves against first allowed directory" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/workspace/a", "/workspace/b" ]

                    result =
                        validatePath allowedDirs "file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/workspace/a/file.txt"

                    Err _ ->
                        Expect.fail "Expected Ok but got error"
        , test "absolute path valid in first allowed directory passes" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/workspace/a", "/workspace/b" ]

                    result =
                        validatePath allowedDirs "/workspace/a/file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/workspace/a/file.txt"

                    Err _ ->
                        Expect.fail "Expected Ok but got error"
        , test "absolute path valid in second allowed directory passes" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/workspace/a", "/workspace/b" ]

                    result =
                        validatePath allowedDirs "/workspace/b/file.txt"
                in
                when result is
                    Ok validPath ->
                        Expect.equal
                            (Validation.toString validPath)
                            "/workspace/b/file.txt"

                    Err _ ->
                        Expect.fail "Expected Ok but got error"
        , test "absolute path outside all allowed directories fails" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/workspace/a", "/workspace/b" ]

                    result =
                        validatePath allowedDirs "/workspace/c/file.txt"
                in
                when result is
                    Err (PathOutsideAllowedDirectories _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathOutsideAllowedDirectories error"
        , test "path traversal rejected with multiple directories" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories [ "/workspace/a", "/workspace/b" ]

                    result =
                        validatePath allowedDirs "../escape"
                in
                when result is
                    Err (PathTraversalAttempt _) ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected PathTraversalAttempt error"
        ]


noAllowedDirectoriesTests : Test
noAllowedDirectoriesTests =
    describe "No allowed directories"
        [ test "rejects relative path with empty allowed directories" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories []

                    result =
                        validatePath allowedDirs "file.txt"
                in
                when result is
                    Err NoAllowedDirectories ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected NoAllowedDirectories error"
        , test "rejects absolute path with empty allowed directories" <|
            \_ ->
                let
                    allowedDirs =
                        makeAllowedDirectories []

                    result =
                        validatePath allowedDirs "/some/path/file.txt"
                in
                when result is
                    Err NoAllowedDirectories ->
                        Expect.pass

                    _ ->
                        Expect.fail "Expected NoAllowedDirectories error"
        ]
