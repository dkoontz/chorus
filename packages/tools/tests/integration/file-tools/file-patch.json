{
  "name": "file.patch",
  "scenarios": [
    {
      "name": "Apply single patch",
      "setup": {
        "files": {
          "code.js": "const x = 1;\nconst y = 2;"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "code.js",
        "patches": [
          {
            "find": "const x = 1;",
            "replace": "const x = 10;"
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "code.js": "const x = 10;\nconst y = 2;"
        }
      }
    },
    {
      "name": "Apply multiple patches",
      "setup": {
        "files": {
          "config.json": "{\"debug\": true, \"version\": \"1.0\"}"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "config.json",
        "patches": [
          {
            "find": "\"debug\": true",
            "replace": "\"debug\": false"
          },
          {
            "find": "\"version\": \"1.0\"",
            "replace": "\"version\": \"2.0\""
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 2
        },
        "file_content": {
          "config.json": "{\"debug\": false, \"version\": \"2.0\"}"
        }
      }
    },
    {
      "name": "Patch nonexistent file",
      "input": {
        "tool": "file.patch",
        "path": "missing.txt",
        "patches": [
          {
            "find": "old",
            "replace": "new"
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "ENOENT"
      }
    },
    {
      "name": "Patch with startLine disambiguates duplicate text",
      "setup": {
        "files": {
          "duplicates.txt": "hello world\nhello world\ngoodbye world"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "duplicates.txt",
        "patches": [
          {
            "find": "hello world",
            "replace": "hi world",
            "startLine": 2
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "duplicates.txt": "hello world\nhi world\ngoodbye world"
        }
      }
    },
    {
      "name": "Patch with startLine still fails if not unique after startLine",
      "setup": {
        "files": {
          "still-duplicate.txt": "line one\nfoo\nbar\nfoo\nbaz"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "still-duplicate.txt",
        "patches": [
          {
            "find": "foo",
            "replace": "FOO",
            "startLine": 2
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "not unique"
      }
    },
    {
      "name": "Patch with startLine targeting first line",
      "setup": {
        "files": {
          "first-line.txt": "target\ntarget\ntarget"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "first-line.txt",
        "patches": [
          {
            "find": "target",
            "replace": "REPLACED",
            "startLine": 3
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "first-line.txt": "target\ntarget\nREPLACED"
        }
      }
    },
    {
      "name": "Multi-line patch with startLine",
      "setup": {
        "files": {
          "multiline.txt": "function one() {\n  return 1;\n}\nfunction one() {\n  return 1;\n}"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "multiline.txt",
        "patches": [
          {
            "find": "function one() {\n  return 1;\n}",
            "replace": "function one() {\n  return 2;\n}",
            "startLine": 4
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "multiline.txt": "function one() {\n  return 1;\n}\nfunction one() {\n  return 2;\n}"
        }
      }
    },
    {
      "name": "Patch without startLine still works (backwards compatibility)",
      "setup": {
        "files": {
          "unique.txt": "hello world"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "unique.txt",
        "patches": [
          {
            "find": "hello",
            "replace": "goodbye"
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "unique.txt": "goodbye world"
        }
      }
    },
    {
      "name": "Patch fails when find matches nothing",
      "setup": {
        "files": {
          "content.txt": "hello world\nfoo bar"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "content.txt",
        "patches": [
          {
            "find": "does not exist",
            "replace": "replacement"
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "not found"
      }
    },
    {
      "name": "Patch fails when find matches multiple sections",
      "setup": {
        "files": {
          "duplicated.txt": "function add(a, b) {\n  return a + b;\n}\n\nfunction subtract(a, b) {\n  return a + b;\n}"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "duplicated.txt",
        "patches": [
          {
            "find": "return a + b;",
            "replace": "return a - b;"
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "not unique"
      }
    },
    {
      "name": "Disambiguate duplicate by including surrounding context",
      "setup": {
        "files": {
          "context.txt": "function add(a, b) {\n  return a + b;\n}\n\nfunction subtract(a, b) {\n  return a + b;\n}"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "context.txt",
        "patches": [
          {
            "find": "function subtract(a, b) {\n  return a + b;",
            "replace": "function subtract(a, b) {\n  return a - b;"
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "context.txt": "function add(a, b) {\n  return a + b;\n}\n\nfunction subtract(a, b) {\n  return a - b;\n}"
        }
      }
    },
    {
      "name": "Disambiguate duplicate by including full line",
      "setup": {
        "files": {
          "fullline.txt": "const DEBUG = true;\nconst VERBOSE = true;\nconst LOGGING = true;"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "fullline.txt",
        "patches": [
          {
            "find": "const VERBOSE = true;",
            "replace": "const VERBOSE = false;"
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "fullline.txt": "const DEBUG = true;\nconst VERBOSE = false;\nconst LOGGING = true;"
        }
      }
    },
    {
      "name": "Patch with startLine=1 searches entire file",
      "setup": {
        "files": {
          "from-start.txt": "unique content\nsecond line"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "from-start.txt",
        "patches": [
          {
            "find": "unique content",
            "replace": "replaced content",
            "startLine": 1
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 1
        },
        "file_content": {
          "from-start.txt": "replaced content\nsecond line"
        }
      }
    },
    {
      "name": "Patch with startLine fails when find exists only before startLine",
      "setup": {
        "files": {
          "before-start.txt": "target text\nsecond line\nthird line"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "before-start.txt",
        "patches": [
          {
            "find": "target text",
            "replace": "replaced",
            "startLine": 2
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "not found"
      }
    },
    {
      "name": "Patch with startLine beyond file length fails",
      "setup": {
        "files": {
          "short-file.txt": "line one\nline two"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "short-file.txt",
        "patches": [
          {
            "find": "line one",
            "replace": "replaced",
            "startLine": 100
          }
        ]
      },
      "expect": {
        "status": "error",
        "error_contains": "not found"
      }
    },
    {
      "name": "Multiple patches with different startLines",
      "setup": {
        "files": {
          "multi-patch.txt": "alpha\nbeta\ngamma\ndelta"
        }
      },
      "input": {
        "tool": "file.patch",
        "path": "multi-patch.txt",
        "patches": [
          {
            "find": "alpha",
            "replace": "ALPHA",
            "startLine": 1
          },
          {
            "find": "gamma",
            "replace": "GAMMA",
            "startLine": 3
          }
        ]
      },
      "expect": {
        "status": "success",
        "output": {
          "success": true,
          "patches_applied": 2
        },
        "file_content": {
          "multi-patch.txt": "ALPHA\nbeta\nGAMMA\ndelta"
        }
      }
    }
  ]
}
